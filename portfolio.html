<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio — Annick Bouvattier</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">
</head>

<body class="portfolio">
  <div class="page">
    <div class="container">
      <header class="top">
        <a class="brand" href="index.html">ANNICK&nbsp;BOUVATTIER</a>
        <nav class="top__nav" aria-label="Navigation principale">
          <a class="nav__link" href="index.html">Accueil</a>
          <a class="nav__link is-active" href="portfolio.html">Portfolio</a>
          <a class="nav__link" href="galeries.html">Galeries</a>
          <a class="nav__link" href="expositions.html">Expositions</a>
          <a class="nav__link" href="apropos.html">À propos</a>
          <a class="nav__link" href="presse.html">Presse</a>
          <a class="nav__link" href="contact.html">Contact</a>
        </nav>
      </header>

      <!-- Chips actives -->
      <div class="filterChips" id="chips"></div>

      <!-- Barre de filtres -->
      <section class="filterBar" aria-label="Filtres">
        <div class="field field--search">
          <input id="q" class="pillInput" type="search" placeholder="Rechercher une œuvre…" />
        </div>

        <!-- Année -->
        <div class="dd" data-key="year">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Année <span class="pillCount" data-count="year"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Année" data-panel="year"></div>
        </div>

        <!-- Technique -->
        <div class="dd" data-key="technique">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Technique <span class="pillCount" data-count="technique"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Technique" data-panel="technique"></div>
        </div>

        <!-- Format -->
        <div class="dd" data-key="size">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Format <span class="pillCount" data-count="size"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Format" data-panel="size"></div>
        </div>

        <!-- Disponible -->
        <div class="dd" data-key="status">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Disponible <span class="pillCount" data-count="status"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Disponible" data-panel="status"></div>
        </div>

        <button class="pillBtn pillBtn--ghost" id="reset" type="button">Tout effacer</button>
      </section>

      <div class="metaRow">
        <h1 class="title">Portfolio</h1>
        <div class="count" id="count"></div>
      </div>

      <section class="masonry" id="masonry" aria-label="Œuvres"></section>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="modal">
    <div class="modal">
      <div class="modal__media">
        <img class="modal__img" id="modalImg" alt="">
        <button class="modal__closeBtn" id="modalClose" type="button" aria-label="Fermer">×</button>
      </div>

      <div class="modal__info">
        <h2 class="modal__h" id="modalTitle"></h2>
        <p class="modal__meta" id="modalMeta"></p>
      </div>
    </div>
  </dialog>

  <script>
    /* =========================
       CONFIG
       ========================= */

    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmK-RAKlpq_VMnhd78eWdWeMTnCkU3_-411IzeTyzO9j0zbJdkkhzfxlRDZpqzKixpoUgTtAAI_Auw/pub?output=csv";
    const IMG_BASE = "images";

    /* =========================
       DOM
       ========================= */

    const els = {
      q: document.getElementById("q"),
      reset: document.getElementById("reset"),
      masonry: document.getElementById("masonry"),
      count: document.getElementById("count"),
      chips: document.getElementById("chips"),

      modal: document.getElementById("modal"),
      modalImg: document.getElementById("modalImg"),
      modalTitle: document.getElementById("modalTitle"),
      modalMeta: document.getElementById("modalMeta"),
      modalClose: document.getElementById("modalClose"),
    };

    const ddEls = {
      year: document.querySelector('.dd[data-key="year"]'),
      technique: document.querySelector('.dd[data-key="technique"]'),
      size: document.querySelector('.dd[data-key="size"]'),
      status: document.querySelector('.dd[data-key="status"]'),
    };

    const panels = {
      year: document.querySelector('[data-panel="year"]'),
      technique: document.querySelector('[data-panel="technique"]'),
      size: document.querySelector('[data-panel="size"]'),
      status: document.querySelector('[data-panel="status"]'),
    };

    const countBadges = {
      year: document.querySelector('[data-count="year"]'),
      technique: document.querySelector('[data-count="technique"]'),
      size: document.querySelector('[data-count="size"]'),
      status: document.querySelector('[data-count="status"]'),
    };

    let artworks = [];

    // état des filtres (multi)
    const filters = {
      q: "",
      year: new Set(),
      technique: new Set(),
      size: new Set(),
      status: new Set(),
    };

    /* =========================
       HELPERS
       ========================= */

    function uniq(arr){ return [...new Set(arr)].sort((a,b)=> (""+a).localeCompare(""+b, "fr")); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normSize(s){
      return String(s ?? "")
        .toLowerCase()
        .replaceAll("×","x")
        .replace(/\s+/g," ")
        .replace(/\s*x\s*/g," x ")
        .replace(/\s*cm\s*/g," cm")
        .trim();
    }

    function normalizeHeader(h){
      return String(h ?? "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const c = text[i];
        const next = text[i+1];

        if(c === '"' && next === '"'){
          value += '"';
          i++;
          continue;
        }
        if(c === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if(c === "," && !inQuotes){
          row.push(value.trim());
          value = "";
          continue;
        }
        if((c === "\n" || c === "\r") && !inQuotes){
          if(value.length || row.length){
            row.push(value.trim());
            rows.push(row);
            row = [];
            value = "";
          }
          continue;
        }
        value += c;
      }

      if(value.length || row.length){
        row.push(value.trim());
        rows.push(row);
      }

      return rows;
    }

    function cleanNA(v){
      const s = String(v ?? "").trim();
      if(!s) return "";
      if(s.toUpperCase() === "N/A") return "";
      return s;
    }

    function statusFromSheet(v){
      const s = String(v ?? "").trim().toUpperCase();
      return (s === "VENDUE") ? "vendue" : "disponible";
    }

    function setBadgeCount(key){
      const n = filters[key].size;
      countBadges[key].textContent = n ? String(n) : "";
    }

    function closeAllDropdowns(){
      Object.values(ddEls).forEach(dd => {
        dd.classList.remove("is-open");
        const btn = dd.querySelector("button[aria-expanded]");
        if(btn) btn.setAttribute("aria-expanded", "false");
      });
    }

    /* =========================
       LOAD FROM GOOGLE SHEET
       ========================= */

    async function loadArtworksFromSheet(){
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("Impossible de charger la Google Sheet");

      const csv = await res.text();
      const rows = parseCSV(csv);

      const header = rows.shift().map(normalizeHeader);
      const col = (name) => header.indexOf(normalizeHeader(name));

      return rows
        .filter(r => r[col("nom")])
        .map(r => {
          const title = cleanNA(r[col("nom")]);
          const yearRaw = cleanNA(r[col("annee")]);
          const year = yearRaw ? Number(yearRaw) : "";
          const category = cleanNA(r[col("categorie")]);
          const technique = cleanNA(r[col("technique")]) || "N/A";
          const format = cleanNA(r[col("format")]);
          const dispo = statusFromSheet(r[col("disponible")]);
          const jpg = cleanNA(r[col("jpg")]);

          const size = format ? `${format} cm` : "N/A";

          // Important: si ton CSV met "portfolio/2011/Oeillade.jpg", ça devient "images/portfolio/2011/Oeillade.jpg"
          const image = `${IMG_BASE}/${jpg}` : "";

          return {
            title,
            year,
            category,
            technique,
            size,
            status: dispo,
            image,
            desc: ""
          };
        })
        .filter(a => a.title && a.image);
    }

    /* =========================
       DROPDOWNS + CHIPS
       ========================= */

    function buildPanel(key, options, normalizer){
      const panel = panels[key];
      panel.innerHTML = "";

      options.forEach(optValue => {
        const v = String(optValue);
        const row = document.createElement("label");
        row.className = "ddRow";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = v;

        const label = document.createElement("span");
        label.className = "ddLabel";
        label.textContent = v;

        // init checked
        input.checked = filters[key].has(normalizer ? normalizer(v) : v);

        input.addEventListener("change", () => {
          const val = normalizer ? normalizer(v) : v;
          if(input.checked) filters[key].add(val);
          else filters[key].delete(val);

          setBadgeCount(key);
          renderChips();
          render();
        });

        row.appendChild(input);
        row.appendChild(label);
        panel.appendChild(row);
      });

      setBadgeCount(key);
    }

    function hydrateDropdowns(){
      const years = uniq(artworks.map(a => a.year).filter(Boolean)).sort((a,b)=>b-a).map(String);
      const techniques = uniq(artworks.map(a => a.technique).filter(Boolean));
      const sizes = uniq(artworks.map(a => normSize(a.size)).filter(Boolean));
      const statuses = ["Disponible","Vendue"];

      buildPanel("year", years);
      buildPanel("technique", techniques);
      buildPanel("size", sizes, normSize);
      buildPanel("status", statuses);
    }

    function renderChips(){
      const chips = [];

      // year
      filters.year.forEach(v => chips.push({ key:"year", label: v }));

      // technique
      filters.technique.forEach(v => chips.push({ key:"technique", label: v }));

      // size (déjà normalisé)
      filters.size.forEach(v => chips.push({ key:"size", label: v }));

      // status
      filters.status.forEach(v => chips.push({ key:"status", label: v }));

      els.chips.innerHTML = "";

      chips.forEach(c => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `
          <span>${escapeHtml(c.label)}</span>
          <button type="button" aria-label="Retirer">×</button>
        `;

        chip.querySelector("button").addEventListener("click", () => {
          filters[c.key].delete(c.label);
          syncCheckboxesForKey(c.key);
          setBadgeCount(c.key);
          renderChips();
          render();
        });

        els.chips.appendChild(chip);
      });
    }

    function syncCheckboxesForKey(key){
      const panel = panels[key];
      const inputs = panel.querySelectorAll('input[type="checkbox"]');
      inputs.forEach(inp => {
        const raw = inp.value;
        const val = (key === "size") ? normSize(raw) : raw;
        inp.checked = filters[key].has(val);
      });
    }

    /* =========================
       FILTERING
       ========================= */

    function matchArtwork(a){
      const q = (filters.q || "").trim().toLowerCase();
      if(q && !a.title.toLowerCase().includes(q)) return false;

      if(filters.year.size && !filters.year.has(String(a.year))) return false;
      if(filters.technique.size && !filters.technique.has(a.technique)) return false;

      const s = normSize(a.size);
      if(filters.size.size && !filters.size.has(s)) return false;

      if(filters.status.size && !filters.status.has(a.status)) return false;

      return true;
    }

    /* =========================
       RENDER GRID
       ========================= */

    function render(){
      const list = artworks.filter(matchArtwork);

      els.masonry.innerHTML = "";
      list.forEach(a=>{
        const item = document.createElement("article");
        item.className = "piece";
        item.innerHTML = `
          <div class="imgWrap">
            <img src="${a.image}" alt="${escapeHtml(a.title)}" loading="lazy">
          </div>
          <div class="cap">
            <p class="capTitle">${escapeHtml(a.title)}</p>
            <p class="capMeta">${escapeHtml(a.technique)} · ${escapeHtml(a.size)} · ${a.year}</p>
            <span class="badge ${a.status}">
              ${a.status === "vendue" ? "VENDUE" : "DISPONIBLE"}
            </span>
          </div>
        `;

        item.addEventListener("click", ()=> openModal(a));
        els.masonry.appendChild(item);
      });

      els.count.textContent = `${list.length} œuvre${list.length>1 ? "s" : ""}`;
    }

    /* =========================
       MODAL
       ========================= */

    function openModal(a){
      els.modalImg.src = a.image;
      els.modalImg.alt = a.title;

      els.modalTitle.textContent = a.title.toUpperCase();

      const label = (a.status === "vendue") ? "VENDUE" : "DISPONIBLE";
      els.modalMeta.innerHTML =
        `${escapeHtml(a.technique)} · ${escapeHtml(a.size)} · ${a.year} · ` +
        `<span class="statusText ${a.status}">${label}</span>`;

      els.modal.showModal();
    }

    function closeModal(){ els.modal.close(); }

    /* =========================
       EVENTS
       ========================= */

    // Recherche
    els.q.addEventListener("input", () => {
      filters.q = els.q.value || "";
      render();
    });

    // Reset
    els.reset.addEventListener("click", ()=>{
      filters.q = "";
      filters.year.clear();
      filters.technique.clear();
      filters.size.clear();
      filters.status.clear();

      els.q.value = "";
      // remettre checkboxes
      ["year","technique","size","status"].forEach(k => {
        syncCheckboxesForKey(k);
        setBadgeCount(k);
      });

      renderChips();
      render();
    });

    // Dropdown open/close
    Object.values(ddEls).forEach(dd => {
      const btn = dd.querySelector(".pillBtn");
      btn.addEventListener("click", (e) => {
        e.stopPropagation();

        const isOpen = dd.classList.contains("is-open");
        closeAllDropdowns();
        if(!isOpen){
          dd.classList.add("is-open");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    });

    // Click extérieur : ferme
    document.addEventListener("click", () => closeAllDropdowns());

    // Empêche fermeture quand on clique dans le panel
    Object.values(panels).forEach(p => p.addEventListener("click", (e) => e.stopPropagation()));

    // Modal
    els.modalClose.addEventListener("click", closeModal);
    els.modal.addEventListener("click", (e)=>{ if(e.target === els.modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && els.modal.open) closeModal(); });

    /* =========================
       INIT
       ========================= */

    document.addEventListener("DOMContentLoaded", async () => {
      try{
        artworks = await loadArtworksFromSheet();
        hydrateDropdowns();
        renderChips();
        render();
      } catch(err){
        console.error(err);
        els.count.textContent = "Erreur de chargement (Sheet/Images)";
      }
    });
  </script>
</body>
</html>
