<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio — Annick Bouvattier</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

  <!-- mini styles pour sous-titres dans le dropdown "Format" -->
  <style>
    body.portfolio .ddHeading{
      margin: 8px 6px 6px;
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.65);
      font-weight: 900;
    }
    body.portfolio .ddSep{
      height:1px;
      background: rgba(255,255,255,.14);
      margin: 10px 6px;
      border-radius: 99px;
    }
  </style>
</head>

<body class="portfolio">
  <div class="page">
    <div class="container">
      <header class="top">
        <a class="brand" href="index.html">ANNICK&nbsp;BOUVATTIER</a>
        <nav class="top__nav" aria-label="Navigation principale">
          <a class="nav__link" href="index.html">Accueil</a>
          <a class="nav__link is-active" href="portfolio.html">Portfolio</a>
          <a class="nav__link" href="galeries.html">Galeries</a>
          <a class="nav__link" href="expositions.html">Expositions</a>
          <a class="nav__link" href="apropos.html">À propos</a>
          <a class="nav__link" href="presse.html">Presse</a>
          <a class="nav__link" href="contact.html">Contact</a>
        </nav>
      </header>

      <!-- Chips actives -->
      <div class="filterChips" id="chips"></div>

      <!-- Barre de filtres -->
      <section class="filterBar" aria-label="Filtres">
        <div class="field field--search">
          <input id="q" class="pillInput" type="search" placeholder="Rechercher une œuvre…" />
        </div>

        <!-- Catégorie (colonne C) -->
        <div class="dd" data-key="category">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Catégorie <span class="pillCount" data-count="category"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Catégorie" data-panel="category"></div>
        </div>

        <!-- Technique -->
        <div class="dd" data-key="technique">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Technique <span class="pillCount" data-count="technique"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Technique" data-panel="technique"></div>
        </div>

        <!-- Format (Forme + tailles) -->
        <div class="dd" data-key="format">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Format <span class="pillCount" data-count="format"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Format" data-panel="format"></div>
        </div>

        <!-- Disponible -->
        <div class="dd" data-key="status">
          <button class="pillBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            Disponible <span class="pillCount" data-count="status"></span>
            <span class="pillCaret">▾</span>
          </button>
          <div class="ddPanel" role="listbox" aria-label="Disponible" data-panel="status"></div>
        </div>

        <button class="pillBtn pillBtn--ghost" id="reset" type="button">Tout effacer</button>
      </section>

      <div class="metaRow">
        <h1 class="title">Portfolio</h1>
        <div class="count" id="count"></div>
      </div>

      <section class="masonry" id="masonry" aria-label="Œuvres"></section>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="modal">
    <div class="modal">
      <div class="modal__media">
        <img class="modal__img" id="modalImg" alt="">
        <button class="modal__closeBtn" id="modalClose" type="button" aria-label="Fermer">×</button>
      </div>

      <div class="modal__info">
        <h2 class="modal__h" id="modalTitle"></h2>
        <p class="modal__meta" id="modalMeta"></p>
      </div>
    </div>
  </dialog>

  <script>
    /* =========================
       CONFIG
       ========================= */

    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmK-RAKlpq_VMnhd78eWdWeMTnCkU3_-411IzeTyzO9j0zbJdkkhzfxlRDZpqzKixpoUgTtAAI_Auw/pub?output=csv";
    const IMG_BASE = "images";

    /* =========================
       DOM
       ========================= */

    const els = {
      q: document.getElementById("q"),
      reset: document.getElementById("reset"),
      masonry: document.getElementById("masonry"),
      count: document.getElementById("count"),
      chips: document.getElementById("chips"),

      modal: document.getElementById("modal"),
      modalImg: document.getElementById("modalImg"),
      modalTitle: document.getElementById("modalTitle"),
      modalMeta: document.getElementById("modalMeta"),
      modalClose: document.getElementById("modalClose"),
    };

    const ddEls = {
      category: document.querySelector('.dd[data-key="category"]'),
      technique: document.querySelector('.dd[data-key="technique"]'),
      format: document.querySelector('.dd[data-key="format"]'),
      status: document.querySelector('.dd[data-key="status"]'),
    };

    const panels = {
      category: document.querySelector('[data-panel="category"]'),
      technique: document.querySelector('[data-panel="technique"]'),
      format: document.querySelector('[data-panel="format"]'),
      status: document.querySelector('[data-panel="status"]'),
    };

    const countBadges = {
      category: document.querySelector('[data-count="category"]'),
      technique: document.querySelector('[data-count="technique"]'),
      format: document.querySelector('[data-count="format"]'),
      status: document.querySelector('[data-count="status"]'),
    };

    let artworks = [];

    // filtres multi
    const filters = {
      q: "",
      category: new Set(),
      technique: new Set(),
      // format = 2 sous-filtres dans le même dropdown
      shape: new Set(),    // "carre" | "paysage" | "portrait"
      size: new Set(),     // ex: "100 x 81 cm" normalisé
      status: new Set(),   // "disponible" | "vendue"
    };

    /* =========================
       HELPERS
       ========================= */

    function uniq(arr){ return [...new Set(arr)].sort((a,b)=> (""+a).localeCompare(""+b, "fr")); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeHeader(h){
      return String(h ?? "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function normSize(s){
      return String(s ?? "")
        .toLowerCase()
        .replaceAll("×","x")
        .replace(/\s+/g," ")
        .replace(/\s*x\s*/g," x ")
        .replace(/\s*cm\s*/g," cm")
        .trim();
    }

    function parseDims(sizeStr){
      // attend un truc du style "100 x 81 cm" ou "100×81" ou "100 x 81"
      const s = normSize(sizeStr);
      const m = s.match(/(\d+(?:[.,]\d+)?)\s*x\s*(\d+(?:[.,]\d+)?)/i);
      if(!m) return null;
      const w = parseFloat(m[1].replace(",", "."));
      const h = parseFloat(m[2].replace(",", "."));
      if(!isFinite(w) || !isFinite(h)) return null;
      return { w, h };
    }

    function shapeFromSize(sizeStr){
      const d = parseDims(sizeStr);
      if(!d) return "unknown";
      if(Math.abs(d.w - d.h) < 0.0001) return "carre";
      return (d.w > d.h) ? "paysage" : "portrait";
    }

    function shapeLabel(key){
      if(key === "carre") return "Carré";
      if(key === "paysage") return "Paysage";
      if(key === "portrait") return "Portrait";
      return "Autre";
    }

    // CSV robuste (gère guillemets + virgules)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const c = text[i];
        const next = text[i+1];

        if(c === '"' && next === '"'){
          value += '"';
          i++;
          continue;
        }
        if(c === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if(c === "," && !inQuotes){
          row.push(value.trim());
          value = "";
          continue;
        }
        if((c === "\n" || c === "\r") && !inQuotes){
          if(value.length || row.length){
            row.push(value.trim());
            rows.push(row);
            row = [];
            value = "";
          }
          continue;
        }
        value += c;
      }

      if(value.length || row.length){
        row.push(value.trim());
        rows.push(row);
      }

      return rows;
    }

    function cleanNA(v){
      const s = String(v ?? "").trim();
      if(!s) return "";
      if(s.toUpperCase() === "N/A") return "";
      return s;
    }

    function statusFromSheet(v){
      const s = String(v ?? "").trim().toUpperCase();
      return (s === "VENDUE") ? "vendue" : "disponible";
    }

    function buildImagePath(jpg){
      let p = String(jpg || "").trim();
      p = p.replace(/^images\//i, "");
      p = p.replace(/^\/+/, "");
      return encodeURI(`${IMG_BASE}/${p}`);
    }

    function setBadgeCount(key){
      let n = 0;
      if(key === "format"){
        n = filters.shape.size + filters.size.size;
      }else{
        n = filters[key].size;
      }
      countBadges[key].textContent = n ? String(n) : "";
    }

    function closeAllDropdowns(){
      Object.values(ddEls).forEach(dd => {
        dd.classList.remove("is-open");
        const btn = dd.querySelector("button[aria-expanded]");
        if(btn) btn.setAttribute("aria-expanded", "false");
      });
    }

    /* =========================
       LOAD
       ========================= */

    async function loadArtworksFromSheet(){
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("Impossible de charger la Google Sheet");

      const csv = await res.text();
      const rows = parseCSV(csv);

      const header = rows.shift().map(normalizeHeader);
      const col = (name) => header.indexOf(normalizeHeader(name));

      // Ton sheet : Nom | Année | Catégorie | Technique | Format | Disponible | Jpg
      // => On charge Catégorie, Technique, Format, Disponible, Jpg
      return rows
        .filter(r => r[col("nom")])
        .map(r => {
          const title = cleanNA(r[col("nom")]);
          const category = cleanNA(r[col("categorie")]);        // ✅ colonne C
          const technique = cleanNA(r[col("technique")]) || "N/A";
          const formatRaw = cleanNA(r[col("format")]);
          const dispo = statusFromSheet(r[col("disponible")]);
          const jpg = cleanNA(r[col("jpg")]);

          const size = formatRaw ? `${formatRaw} cm` : "N/A";
          const sizeNorm = normSize(size);
          const shape = shapeFromSize(sizeNorm);

          const image = jpg ? buildImagePath(jpg) : "";

          return { title, category, technique, size, sizeNorm, shape, status: dispo, image };
        })
        .filter(a => a.title && a.image);
    }

    /* =========================
       PANELS (Category / Technique / Status)
       ========================= */

    function buildSimplePanel(key, options){
      const panel = panels[key];
      panel.innerHTML = "";

      options.forEach(v => {
        const row = document.createElement("label");
        row.className = "ddRow";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = v;
        input.checked = filters[key].has(v);

        const label = document.createElement("span");
        label.className = "ddLabel";
        label.textContent = v;

        input.addEventListener("change", () => {
          if(input.checked) filters[key].add(v);
          else filters[key].delete(v);

          setBadgeCount(key);
          renderChips();
          render();
        });

        row.appendChild(input);
        row.appendChild(label);
        panel.appendChild(row);
      });

      setBadgeCount(key);
    }

    /* =========================
       PANEL FORMAT (Forme + Tailles)
       ========================= */

    function addHeading(panel, text){
      const h = document.createElement("div");
      h.className = "ddHeading";
      h.textContent = text;
      panel.appendChild(h);
    }

    function addSeparator(panel){
      const sep = document.createElement("div");
      sep.className = "ddSep";
      panel.appendChild(sep);
    }

    function addCheckboxRow(panel, checked, labelText, onChange){
      const row = document.createElement("label");
      row.className = "ddRow";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.checked = checked;

      const label = document.createElement("span");
      label.className = "ddLabel";
      label.textContent = labelText;

      input.addEventListener("change", () => onChange(input.checked));

      row.appendChild(input);
      row.appendChild(label);
      panel.appendChild(row);
    }

    function buildFormatPanel(){
  const panel = panels.format;
  panel.innerHTML = "";

  const sizesByShape = {
    carre: uniq(artworks.filter(a => a.shape === "carre").map(a => a.sizeNorm).filter(Boolean)),
    paysage: uniq(artworks.filter(a => a.shape === "paysage").map(a => a.sizeNorm).filter(Boolean)),
    portrait: uniq(artworks.filter(a => a.shape === "portrait").map(a => a.sizeNorm).filter(Boolean)),
  };

  function prettySize(sizeNorm){
    return sizeNorm.replace(/\s*x\s*/g," × ").replace(/\s*cm\s*/g," cm");
  }

  function groupBlock(shapeKey){
    const label = shapeLabel(shapeKey);
    const isOn = filters.shape.has(shapeKey);
    const list = sizesByShape[shapeKey];

    // Ligne Carré / Paysage / Portrait avec checkbox
    const row = document.createElement("label");
    row.className = "ddRow";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = isOn;

    const text = document.createElement("span");
    text.className = "ddLabel";
    text.style.fontWeight = "900";
    text.style.letterSpacing = ".08em";
    text.style.textTransform = "uppercase";
    text.textContent = label;

    input.addEventListener("change", () => {
      if(input.checked) filters.shape.add(shapeKey);
      else filters.shape.delete(shapeKey);

      setBadgeCount("format");
      renderChips();
      render();

      // reconstruit le panel pour afficher/cacher les tailles
      buildFormatPanel();
    });

    row.appendChild(input);
    row.appendChild(text);
    panel.appendChild(row);

    // Tailles visibles uniquement si la forme est cochée
    if(input.checked){
      const wrap = document.createElement("div");
      wrap.style.padding = "4px 0 10px 34px";  // indentation
      wrap.style.display = "grid";
      wrap.style.gap = "6px";

      list.forEach(sizeNorm => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = prettySize(sizeNorm);

        // style minimal sans toucher ton CSS
        btn.style.textAlign = "left";
        btn.style.padding = "8px 10px";
        btn.style.borderRadius = "10px";
        btn.style.border = "1px solid rgba(255,255,255,.18)";
        btn.style.background = filters.size.has(sizeNorm)
          ? "rgba(61,220,132,.18)"
          : "rgba(255,255,255,.06)";
        btn.style.color = "rgba(255,255,255,.92)";
        btn.style.cursor = "pointer";

        btn.addEventListener("click", () => {
          if(filters.size.has(sizeNorm)) filters.size.delete(sizeNorm);
          else filters.size.add(sizeNorm);

          setBadgeCount("format");
          renderChips();
          render();

          // refresh visuel
          buildFormatPanel();
        });

        wrap.appendChild(btn);
      });

      panel.appendChild(wrap);
    }

    // séparateur entre groupes
    const sep = document.createElement("div");
    sep.className = "ddSep";
    panel.appendChild(sep);
  }

  groupBlock("carre");
  groupBlock("paysage");
  groupBlock("portrait");

  setBadgeCount("format");
}


    function hydrateDropdowns(){
      const categories = uniq(artworks.map(a => a.category).filter(Boolean));
      const techniques = uniq(artworks.map(a => a.technique).filter(Boolean));
      const statuses = ["disponible","vendue"];

      buildSimplePanel("category", categories);
      buildSimplePanel("technique", techniques);
      buildFormatPanel();
      buildSimplePanel("status", statuses.map(s => s)); // labels gérés au rendu
    }

    /* =========================
       CHIPS
       ========================= */

    function renderChips(){
      const chips = [];

      filters.category.forEach(v => chips.push({ key:"category", label: v }));
      filters.technique.forEach(v => chips.push({ key:"technique", label: v }));

      filters.shape.forEach(v => chips.push({ key:"shape", label: shapeLabel(v) }));
      filters.size.forEach(v => {
        const display = v.replace(/\s*x\s*/g," × ").replace(/\s*cm\s*/g," cm");
        chips.push({ key:"size", label: display, raw: v });
      });

      filters.status.forEach(v => chips.push({ key:"status", label: (v==="vendue"?"VENDUE":"DISPONIBLE"), raw: v }));

      els.chips.innerHTML = "";

      chips.forEach(c => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `
          <span>${escapeHtml(c.label)}</span>
          <button type="button" aria-label="Retirer">×</button>
        `;

        chip.querySelector("button").addEventListener("click", () => {
          if(c.key === "shape"){
            // enlever forme
            const inv = Object.entries({Carré:"carre", Paysage:"paysage", Portrait:"portrait"})
              .find(([lab]) => lab === c.label);
            const val = inv ? inv[1] : null;
            if(val) filters.shape.delete(val);
          }else if(c.key === "size"){
            filters.size.delete(c.raw);
          }else if(c.key === "status"){
            filters.status.delete(c.raw);
          }else{
            filters[c.key].delete(c.label);
          }

          setBadgeCount("category");
          setBadgeCount("technique");
          setBadgeCount("format");
          setBadgeCount("status");

          // rebuild format panel to sync checkboxes
          buildFormatPanel();

          // rebuild other panels to sync checkboxes
          syncSimplePanel("category");
          syncSimplePanel("technique");
          syncSimplePanel("status");

          renderChips();
          render();
        });

        els.chips.appendChild(chip);
      });
    }

    function syncSimplePanel(key){
      const panel = panels[key];
      const inputs = panel.querySelectorAll('input[type="checkbox"]');
      inputs.forEach(inp => {
        const v = inp.value;
        inp.checked = filters[key].has(v);
      });
    }

    /* =========================
       FILTERING + RENDER
       ========================= */

    function matchArtwork(a){
      const q = (filters.q||"").trim().toLowerCase();
      if(q && !a.title.toLowerCase().includes(q)) return false;

      if(filters.category.size && !filters.category.has(a.category)) return false;
      if(filters.technique.size && !filters.technique.has(a.technique)) return false;

      // Format : forme + tailles (AND)
      if(filters.shape.size && !filters.shape.has(a.shape)) return false;
      if(filters.size.size && !filters.size.has(a.sizeNorm)) return false;

      if(filters.status.size && !filters.status.has(a.status)) return false;

      return true;
    }

    function render(){
      const list = artworks.filter(matchArtwork);

      els.masonry.innerHTML = "";
      list.forEach(a=>{
        const item = document.createElement("article");
        item.className = "piece";
        item.innerHTML = `
          <div class="imgWrap">
            <img src="${a.image}" alt="${escapeHtml(a.title)}" loading="lazy">
          </div>
          <div class="cap">
            <p class="capTitle">${escapeHtml(a.title)}</p>
            <!-- ✅ on enlève l'année : plus de date -->
            <p class="capMeta">${escapeHtml(a.technique)} · ${escapeHtml(a.size)}</p>
            <span class="badge ${a.status}">
              ${a.status === "vendue" ? "VENDUE" : "DISPONIBLE"}
            </span>
          </div>
        `;
        item.addEventListener("click", ()=> openModal(a));
        els.masonry.appendChild(item);
      });

      els.count.textContent = `${list.length} œuvre${list.length>1 ? "s" : ""}`;
    }

    /* =========================
       MODAL
       ========================= */

    function openModal(a){
      els.modalImg.src = a.image;
      els.modalImg.alt = a.title;

      els.modalTitle.textContent = a.title.toUpperCase();

      // ✅ on enlève l'année : pas de date dans le modal
      const label = (a.status === "vendue") ? "VENDUE" : "DISPONIBLE";
      els.modalMeta.innerHTML =
        `${escapeHtml(a.technique)} · ${escapeHtml(a.size)} · ` +
        `<span class="statusText ${a.status}">${label}</span>`;

      els.modal.showModal();
    }

    function closeModal(){ els.modal.close(); }

    /* =========================
       EVENTS
       ========================= */

    els.q.addEventListener("input", () => {
      filters.q = els.q.value || "";
      render();
    });

    els.reset.addEventListener("click", ()=>{
      filters.q = "";
      filters.category.clear();
      filters.technique.clear();
      filters.shape.clear();
      filters.size.clear();
      filters.status.clear();

      els.q.value = "";

      // rebuild panels to reset checks
      hydrateDropdowns();

      renderChips();
      render();
    });

    Object.values(ddEls).forEach(dd => {
      const btn = dd.querySelector(".pillBtn");
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = dd.classList.contains("is-open");
        closeAllDropdowns();
        if(!isOpen){
          dd.classList.add("is-open");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    });

    document.addEventListener("click", () => closeAllDropdowns());
    Object.values(panels).forEach(p => p.addEventListener("click", (e) => e.stopPropagation()));

    els.modalClose.addEventListener("click", closeModal);
    els.modal.addEventListener("click", (e)=>{ if(e.target === els.modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && els.modal.open) closeModal(); });

    /* =========================
       INIT
       ========================= */

    document.addEventListener("DOMContentLoaded", async () => {
      try{
        artworks = await loadArtworksFromSheet();
        hydrateDropdowns();
        renderChips();
        render();
      } catch(err){
        console.error(err);
        els.count.textContent = "Erreur de chargement (Sheet/Images)";
      }
    });
  </script>
</body>
</html>
