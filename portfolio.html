<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio — Annick Bouvattier</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- ✅ un seul css global -->
  <link rel="stylesheet" href="styles.css">
</head>

<body class="portfolio">
  <div class="page">
    <div class="container">
      <header class="top">
        <a class="brand" href="index.html">ANNICK&nbsp;BOUVATTIER</a>
        <nav class="top__nav" aria-label="Navigation principale">
          <a class="nav__link" href="index.html">Accueil</a>
          <a class="nav__link is-active" href="portfolio.html">Portfolio</a>
          <a class="nav__link" href="galeries.html">Galeries</a>
          <a class="nav__link" href="expositions.html">Expositions</a>
          <a class="nav__link" href="informations.html">Informations</a>
          <a class="nav__link" href="apropos.html">À propos</a>
          <a class="nav__link" href="presse.html">Presse</a>
        </nav>
      </header>

      <section class="filters" aria-label="Filtres">
        <div class="field">
          <div class="label">Nom</div>
          <input id="q" type="search" placeholder="Rechercher une œuvre…" />
        </div>

        <div class="field">
          <div class="label">Année</div>
          <select id="year">
            <option value="all">Toutes</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Technique</div>
          <select id="technique">
            <option value="all">Toutes</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Format</div>
          <select id="size">
            <option value="all">Toutes</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Disponible / Vendue</div>
          <select id="status">
            <option value="all">Toutes</option>
            <option value="disponible">Disponible</option>
            <option value="vendue">Vendue</option>
          </select>
        </div>

        <button class="btn" id="reset" type="button">Réinitialiser</button>
      </section>

      <div class="metaRow">
        <h1 class="title">Portfolio</h1>
        <div class="count" id="count"></div>
      </div>

      <section class="masonry" id="masonry" aria-label="Œuvres"></section>
    </div>
  </div>

  <!-- ✅ Modal (image max + texte dessous, centré) -->
  <dialog id="modal">
    <div class="modal">
      <div class="modal__media">
        <img class="modal__img" id="modalImg" alt="">
        <button class="modal__closeBtn" id="modalClose" type="button" aria-label="Fermer">×</button>
      </div>

      <div class="modal__info">
        <h2 class="modal__h" id="modalTitle"></h2>
        <p class="modal__meta" id="modalMeta"></p>
      </div>
    </div>
  </dialog>

  <script>
    /* =========================
       CONFIG
       ========================= */

    // ✅ Colle ici le lien "Publier sur le Web" en CSV
    // Exemple : https://docs.google.com/spreadsheets/d/<ID>/pub?gid=<GID>&single=true&output=csv
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/15i_u9qfb7j1cdUAPlC2N9KmtjNZF4W1xk86JxaXzsT8/edit?usp=sharing";

    // ✅ Images dans ton repo :
    // images/portfolio/2011/Oeillade.jpg
    const IMG_BASE = "images";

    /* =========================
       DOM
       ========================= */

    const els = {
      q: document.getElementById("q"),
      year: document.getElementById("year"),
      technique: document.getElementById("technique"),
      size: document.getElementById("size"),
      status: document.getElementById("status"),
      reset: document.getElementById("reset"),
      masonry: document.getElementById("masonry"),
      count: document.getElementById("count"),

      modal: document.getElementById("modal"),
      modalImg: document.getElementById("modalImg"),
      modalTitle: document.getElementById("modalTitle"),
      modalMeta: document.getElementById("modalMeta"),
      modalClose: document.getElementById("modalClose"),
    };

    let artworks = [];

    /* =========================
       HELPERS
       ========================= */

    function uniq(arr){ return [...new Set(arr)].sort((a,b)=> (""+a).localeCompare(""+b)); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normSize(s){
      return String(s ?? "")
        .toLowerCase()
        .replaceAll("×","x")
        .replace(/\s+/g," ")
        .replace(/\s*x\s*/g," x ")
        .replace(/\s*cm\s*/g," cm")
        .trim();
    }

    function normalizeHeader(h){
      return String(h ?? "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // enlève accents
        .trim();
    }

    // Parse CSV robuste (gère les guillemets + virgules)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const c = text[i];
        const next = text[i+1];

        if(c === '"' && next === '"'){
          value += '"';
          i++;
          continue;
        }
        if(c === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if(c === "," && !inQuotes){
          row.push(value.trim());
          value = "";
          continue;
        }
        if((c === "\n" || c === "\r") && !inQuotes){
          if(value.length || row.length){
            row.push(value.trim());
            rows.push(row);
            row = [];
            value = "";
          }
          continue;
        }
        value += c;
      }

      if(value.length || row.length){
        row.push(value.trim());
        rows.push(row);
      }

      return rows;
    }

    function cleanNA(v){
      const s = String(v ?? "").trim();
      if(!s) return "";
      if(s.toUpperCase() === "N/A") return "";
      return s;
    }

    function statusFromSheet(v){
      const s = String(v ?? "").trim().toUpperCase();
      return (s === "VENDUE") ? "vendue" : "disponible";
    }

    /* =========================
       LOAD FROM GOOGLE SHEET
       ========================= */

    async function loadArtworksFromSheet(){
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("Impossible de charger la Google Sheet");

      const csv = await res.text();
      const rows = parseCSV(csv);

      const header = rows.shift().map(normalizeHeader);
      const col = (name) => header.indexOf(normalizeHeader(name));

      // Ton sheet : Nom | Année | Catégorie | Technique | Format | Disponible | Jpg
      return rows
        .filter(r => r[col("nom")])
        .map(r => {
          const title = cleanNA(r[col("nom")]);
          const yearRaw = cleanNA(r[col("annee")]);
          const year = yearRaw ? Number(yearRaw) : "";
          const category = cleanNA(r[col("categorie")]);
          const technique = cleanNA(r[col("technique")]) || "N/A";
          const format = cleanNA(r[col("format")]);
          const dispo = statusFromSheet(r[col("disponible")]);
          const jpg = cleanNA(r[col("jpg")]);

          // Format affiché : "60 x 120 cm" (si fourni)
          const size = format ? `${format} cm` : "N/A";

          // Image : images/portfolio/2011/Oeillade.jpg
          const image = jpg ? `${IMG_BASE}/${jpg}` : "";

          return {
            title,
            year,
            category,
            technique,
            size,
            status: dispo,
            image,
            desc: ""
          };
        })
        .filter(a => a.title && a.image); // garde uniquement les lignes valides
    }

    /* =========================
       FILTERS
       ========================= */

    function resetFilterSelect(selectEl){
      // garde uniquement la première option ("Toutes")
      while(selectEl.options.length > 1) selectEl.remove(1);
    }

    function hydrateFilters(){
      resetFilterSelect(els.year);
      resetFilterSelect(els.technique);
      resetFilterSelect(els.size);

      const years = uniq(artworks.map(a=>a.year).filter(Boolean)).sort((a,b)=>b-a);
      const techniques = uniq(artworks.map(a=>a.technique).filter(Boolean));
      const sizes = uniq(artworks.map(a=>normSize(a.size)).filter(Boolean));

      years.forEach(y=>{
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        els.year.appendChild(opt);
      });

      techniques.forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        els.technique.appendChild(opt);
      });

      sizes.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        els.size.appendChild(opt);
      });
    }

    function match(a, f){
      const q = (f.q||"").trim().toLowerCase();
      if(q && !a.title.toLowerCase().includes(q)) return false;

      if(f.year !== "all" && String(a.year) !== f.year) return false;
      if(f.technique !== "all" && a.technique !== f.technique) return false;
      if(f.size !== "all" && normSize(a.size) !== f.size) return false;
      if(f.status !== "all" && a.status !== f.status) return false;

      return true;
    }

    /* =========================
       RENDER GRID
       ========================= */

    function render(){
      const f = {
        q: els.q.value || "",
        year: els.year.value,
        technique: els.technique.value,
        size: els.size.value,
        status: els.status.value
      };

      const list = artworks.filter(a => match(a, f));

      els.masonry.innerHTML = "";
      list.forEach(a=>{
        const item = document.createElement("article");
        item.className = "piece";
        item.innerHTML = `
          <div class="imgWrap">
            <img src="${a.image}" alt="${escapeHtml(a.title)}" loading="lazy">
          </div>
          <div class="cap">
            <p class="capTitle">${escapeHtml(a.title)}</p>
            <p class="capMeta">${escapeHtml(a.technique)} · ${escapeHtml(a.size)} · ${a.year}</p>
            <span class="badge ${a.status}">
              ${a.status === "vendue" ? "VENDUE" : "DISPONIBLE"}
            </span>
          </div>
        `;
        item.addEventListener("click", ()=> openModal(a));
        els.masonry.appendChild(item);
      });

      els.count.textContent = `${list.length} œuvre${list.length>1 ? "s" : ""}`;
    }

    /* =========================
       MODAL
       ========================= */

    function openModal(a){
      els.modalImg.src = a.image;
      els.modalImg.alt = a.title;

      els.modalTitle.textContent = a.title.toUpperCase();

      const label = (a.status === "vendue") ? "VENDUE" : "DISPONIBLE";
      els.modalMeta.innerHTML = `${escapeHtml(a.technique)} · ${escapeHtml(a.size)} · ${a.year} · <span class="statusText ${a.status}">${label}</span>`;

      els.modal.showModal();
    }

    function closeModal(){ els.modal.close(); }

    /* =========================
       EVENTS
       ========================= */

    ["input","change"].forEach(evt=>{
      els.q.addEventListener(evt, render);
      els.year.addEventListener(evt, render);
      els.technique.addEventListener(evt, render);
      els.size.addEventListener(evt, render);
      els.status.addEventListener(evt, render);
    });

    els.reset.addEventListener("click", ()=>{
      els.q.value = "";
      els.year.value = "all";
      els.technique.value = "all";
      els.size.value = "all";
      els.status.value = "all";
      render();
    });

    els.modalClose.addEventListener("click", closeModal);
    els.modal.addEventListener("click", (e)=>{ if(e.target === els.modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && els.modal.open) closeModal(); });

    /* =========================
       INIT
       ========================= */

    document.addEventListener("DOMContentLoaded", async () => {
      try{
        artworks = await loadArtworksFromSheet();
        hydrateFilters();
        render();
      } catch(err){
        console.error(err);
        els.count.textContent = "Erreur de chargement (Sheet/Images)";
      }
    });

    // Option "auto refresh" (toutes les 2 minutes)
    // setInterval(async ()=>{
    //   try{
    //     artworks = await loadArtworksFromSheet();
    //     hydrateFilters();
    //     render();
    //   }catch(e){
    //     console.warn("refresh failed", e);
    //   }
    // }, 120000);

  </script>
</body>
</html>
